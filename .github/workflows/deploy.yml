name: Deploy ToDo Application

on:
    push:
      branches:
        - main
  
  jobs:
    build:
      runs-on: ubuntu-latest
  
      steps:
        - name: Checkout code
          uses: actions/checkout@v3
  
        - name: Set up Docker
          uses: docker/setup-buildx-action@v2
  
        - name: Build and push Docker images
          run: |
            docker-compose -f docker-compose.yml build
            docker-compose -f docker-compose.yml push
  
    deploy:
      runs-on: ubuntu-latest
      needs: build
  
      steps:
        - name: Checkout code
          uses: actions/checkout@v3
  
        - name: Deploy to Ubuntu Server
          env:
            HOST: ${{ secrets.HOST }}
            USERNAME: ${{ secrets.USERNAME }}
            PASSWORD: ${{ secrets.PASSWORD }}
            PORT: ${{ secrets.PORT }}
          run: |
            sshpass -p "${{ secrets.PASSWORD }}" ssh -o StrictHostKeyChecking=no -p ${{ secrets.PORT }} ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
            cd /home/username/todo-app
            docker-compose down
            docker-compose pull
            docker-compose up -d
            EOF